# Disabled - amd64 build ~30 minutes, arm builds ~300 minutes?
branches:
  only:
    - xarch

dist: trusty
language: python
group: edge

python:
  - "3.6"
services:
  - docker

addons:
  apt:
    packages:
      - docker-ce

env:
  global:
    - SERVICE1="orthanc"
    - SERVICE2="orthanc-plugins"

  matrix:
    - ARCH_TAG="amd64"
    - ARCH_TAG="arm32v7"
    - ARCH_TAG="arm64v8"

before_install:

  # Put docker into "experimental" for manifest function
  - mkdir -p $HOME/.docker
  - echo '{"experimental":"enabled"}' > "$HOME/.docker/config.json"

  - pip3 install pyyaml  # for manifest-it

    # Register qemu as cross-compiler
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset

install:

  # Build image
  - docker-compose build $SERVICE1-$ARCH_TAG
  - docker-compose build $SERVICE2-$ARCH_TAG

script: true

after_success:

  # Login to docker for push
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker push $DOCKER_USERNAME/$SERVICE1-$ARCH_TAG
  - docker push $DOCKER_USERNAME/$SERVICE2-$ARCH_TAG

jobs:
  include:
    - stage: deploy
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        # Pull all of the outputs -- this stage does not have access to the build-stage Docker image cache
        - docker pull $DOCKER_USERNAME/orthanc-amd64
        - docker pull $DOCKER_USERNAME/orthanc-arm32v7
        - docker pull $DOCKER_USERNAME/orthanc-arm64v8
        - docker pull $DOCKER_USERNAME/orthanc-plugins-amd64
        - docker pull $DOCKER_USERNAME/orthanc-plugins-arm32v7
        - docker pull $DOCKER_USERNAME/orthanc-plugins-arm64v8
        - # Create a master manifest and push
        - python3 manifest-it.py orthanc-xarch.manifest.yml
